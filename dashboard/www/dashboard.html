<!-- /***************************************************************************
 *   Copyright (C) 2025 by Rick KD0OSS             *
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 3 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 *   This program is distributed in the hope that it will be useful,       *
 *   but WITHOUT ANY WARRANTY; without even the implied warranty of        *
 *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         *
 *   GNU General Public License for more details.                          *
 *                                                                         *
 *   You should have received a copy of the GNU General Public License     *
 *   along with this program; if not, see <http://www.gnu.org/licenses/>   *
 *                                                                         *
 ***************************************************************************/
-->
<html style='height:100%' xmlns='http://www.w3.org/1999/xhtml'>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1" charset='utf-8'>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<title id='windowTitle'>Modem Dashboard</title>
<style>
   * {box-sizing: border-box}
   html
   {
      height: 100%;
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 18px;
      background-color: #000000;
      overflow: hidden;
   }

   #wrap
   {
      padding: 10px;
      min-height: -webkit-calc(100% - 100px);  /* Chrome  */
      min-height: -moz-calc(100% - 100px);     /* Firefox */
      min-height:  calc(100% - 100px);         /* native  */
   }

   header, section, footer, aside, nav, article, figure
   {
      display: block;
      background-color: #000000;
   }

   .dashb
   {
      background-color: #000000;
      overflow: hidden;
   }

   /* Set a style for all buttons */
   .login
   {
     background-color: #04AA6D;
     color: white;
     padding: 14px 20px;
     margin: 8px 0;
     border: none;
     cursor: pointer;
     width: 100%;
   }

   .login:hover, .cancelbtn:hover
   {
     opacity: 0.8;
   }

   .cancelbtn
   {
     width: auto;
     padding: 10px 18px;
     background-color: #f44336;
   }

   .container
   {
     padding: 16px;
   }

   span.psw
   {
     float: right;
     padding-top: 16px;
   }

   /* Center the image and position the close button */
   .imgcontainer
   {
     text-align: center;
     margin: 24px 0 12px 0;
     position: relative;
   }

   /* The Modal (background) */
   .modal
   {
     display: none; /* Hidden by default */
     position: fixed; /* Stay in place */
     z-index: 4; /* Sit on top */
     left: 400;
     top: 0;
     width: 400px; /* Full width */
     height: 400px; /* Full height */
     overflow: auto; /* Enable scroll if needed */
     background-color: rgb(0,0,0); /* Fallback color */
     background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
     padding-top: 60px;
   }

   /* Modal Content/Box */
   .modal-content
   {
     background-color: #fefefe;
     margin: 5% auto 15% auto; /* 5% from the top, 15% from the bottom and centered */
     border: 1px solid #888;
     width: 80%; /* Could be more or less, depending on screen size */
   }

   /* The Close Button (x) */
   .close
   {
     position: absolute;
     right: 25px;
     top: 0;
     z-index: 5; /* Sit on top */
     color: #000;
     font-size: 35px;
     font-weight: bold;
   }

   .close:hover,
   .close:focus
   {
     color: red;
     cursor: pointer;
   }

   /* Add Zoom Animation */
   .animate
   {
     -webkit-animation: animatezoom 0.6s;
     animation: animatezoom 0.6s
   }

   @-webkit-keyframes animatezoom
   {
     from {-webkit-transform: scale(0)}
     to {-webkit-transform: scale(1)}
   }

   @keyframes animatezoom
   {
     from {transform: scale(0)}
     to {transform: scale(1)}
   }

   /* Change styles for span and cancel button on extra small screens */
   @media screen and (max-width: 300px)
   {
     span.psw
     {
       display: block;
       float: none;
     }

     .cancelbtn
     {
       width: 100%;
     }
   }

   .main
   {
     margin-top: 70px;
     margin-left: 291px;
     margin-right: -8px;
     padding: 5px 5px 5px 5px;
     border: 2px solid #ccc;
     overflow: hidden;
   }

   .tabs
   {
      overflow: hidden;
      background-color: #000000;
   }

   .tablink
   {
      background-color: #555;
      color: white;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      font-size: 30px;
      width: 50%;
      height: 50px;
      overflow: hidden;
   }

   .tablink:hover, .stablink:hover
   {
      background-color: #777;
   }

   .tabcontent
    {
      top: 1px;
      color: white;
      display: none;
      height: 100%;
      overflow: hidden;
      background-color: #000000;
      z-index: 3;
    }

   #maintab
   {
      overflow: auto;
      background-color: blue;
   }

   .stablink
   {
      background-color: #666;
      color: #37AD83;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      height: 40px;
      font-size: 20px;
      font-weight: bold;
      width: 15%;
      overflow: hidden;
   }

   .stabs
   {
      margin-top: 1px;
      margin-left: 0px;
      overflow: hidden;
      background-color: #000000;
   }

   #settingtab
   {
      background-color: green;
   }

   .genset
   {
      top: 1px;
      margin-left: 0px;
      color: black;
      display: none;
      height: 100%;
      overflow: hidden;
      background-color: #000000;
      font-size: 20px;
      font-family: "Lucida Console", "Courier New", monospace;
   }

   .genset select, input
   {
      font-size: 20px;
      font-family: "Lucida Console", "Courier New", monospace;
   }

   .settingsauth
   {
      position: absolute;
      top:  200px;
      left: 1px;
      width: 500px;
      display: inline-block;
   }

   .settingsauth input
   {
      position: absolute;
      left: 210px;
   }

   .authSaveButton
   {
      position: relative;
      top: 40px;
      left: -205px;
      font-size: 20px;
      background-color: lightgreen;
   }

   #generaltab
   {
      background-color: orange;
   }

   #modemtab
   {
     background-color: yellow;
   }

   #modetab
   {
     background-color: lightblue;
   }

   .settingsLocation
   {
      position: absolute;
      top: 50px;
      left: 1px;
      width: 300px;
      display: inline-block;
   }

   .settingsLocation input
   {
      position: absolute;
      left: 150px;
      width: 170px;
   }

   .genSettings
   {
      position: relative;
      top: 10px;
      left: 10px;
      height: 400px;
      display: inline-block;
   }

   .genSaveButton
   {
      position: absolute;
      top: 130px;
      font-size: 20px;
      background-color: lightgreen;
   }

   .modemSettings
   {
      position: relative;
      top: 10px;
      left: 10px;
      height: 100%;
      display: inline-block;
   }

   .mExtrasSettings
   {
      position: fixed;
      top: 230px;
      bottom: 80px;
      width: 500px;
      overflow: auto;
      background-color: lightyellow;
      display: inline-block;
   }

   .currentComm
   {
      position: relative;
      top: 1px;
      height: 350px;
      width: 100%;
      overflow: hidden;
      border: 2px solid #ccc;
      background-color: #000000;
      z-index: 3;
   }

   .status
   {
      position: fixed;
      top: 70px;
      left: 0px;
      height: 100%;
      width: 300px;
      padding: 5px 5px 5px 5px;
      overflow: hidden;
      border: 2px solid #ccc;
      background-color: #000000;
   }

   .banner
   {
      position: fixed;
      top: 0;
      left: 0px;
      height: 70px;
      width: 100%;
      overflow: hidden;
      text-align: center;
      font-size: 25px;
      color: yellow;
      border: 2px solid #ccc;
      background-color: #000000;
      z-index: 3;
   }

   .creator
   {
      position: fixed;
      bottom: 0;
      left: 0;
      height: 25px;
      width: 100%;
      overflow: hidden;
      text-align: center;
      font-size: 15px;
      color: yellow;
      border: 2px solid #ccc;
      background-color: #000000;
      z-index: 3;
   }

   .smsText
   {
      position: relative;
      top: 0;
      left: 1px;
      width: 100%;
      height: 100px;
      font-size: 18px;
      color: black;
      border-collapse: collapse;
      background-color: white;
      z-index: 3;
   }

   .smsText textarea
   {
      position: relative;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      font-size: 18px;
      color: black;
      border-collapse: collapse;
      background-color: white;
      z-index: 3;
   }

   .currentCall
   {
      position: relative;
      top: 0;
      left: 1px;
      width: 100%;
      text-align: center;
      font-size: 18px;
      color: #eeeeee;
      border-collapse: collapse;
      background-color: #528dea;
      z-index: 3;
   }

   .currentCall td
   {
      width: 25%;
      height: 25px;
      border: 2px solid #aaa;
      border-collapse: collapse;
   }

   .currentCall th
   {
      color: #eeeeee;
   }

   .currentCall tr
   {
      color: #528dea;
   }

   .currentCall tr:nth-child(even)
   {
      border: 2px solid #aaa;
      background-color: #D6EEEE;
   }

   .activeModes
   {
      position: relative;
      top: 0;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 15px;
      border: 2px solid #aaa;
      border-collapse: collapse;
      background-color: #f5f386;
      z-index: 3;
   }

   .activeModes td
   {
      width: 50%;
      border: 2px solid #aaa;
      border-collapse: collapse;
   }

   .activeGW
   {
      position: relative;
      top: 0;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 15px;
      border: 2px solid #aaa;
      border-collapse: collapse;
      background-color: #078EA6;
      z-index: 3;
   }

   .activeGW td
   {
      width: 50%;
      border: 2px solid #aaa;
      border-collapse: collapse;
   }

   .lastheardDiv
   {
      position: relative;
      top: 1px;
      height: 100%;
      width: 100%;
      overflow: hidden;
      background-color: #000000;
      z-index: 3;
   }

   .lastheard
   {
      position: relative;
      top: 1px;
      width: 100%;
      bottom: 30px;
      left: 1px;
      display: inline-block;
      text-align: center;
      font-size: 15px;
      overflow-y: auto;
      z-index: 3;
   }

   .lastheard thead
   {
      position: sticky; /* Make the header sticky */
      top: 0; /* Stick to the top of the scrollable container */
   }

   .lastheard tr:nth-child(even)
   {
      border: 2px solid #aaa;
      background-color: #BFFFED;
   }

   .lastheard tr:nth-child(odd)
   {
      border: 2px solid #aaa;
      background-color: #FFBFD1;
   }

   .lastheard td, th
   {
      width: 20%;
      border: 2px solid #aaa;
      border-collapse: collapse;
      white-space: nowrap;
      padding: 0px 5px 0px 5px; /* Top, Right, Bottom, Left padding */
   }

   .clock
   {
      position: absolute;
      top: 45px;
      left: 20px;
      width: 200px;
      text-align: left;
      font-size: 16px;
      color: #999999;
      background-color: black;
      z-index: 3;
   }

   .lclock
   {
      position: absolute;
      top: 25px;
      left: 20px;
      width: 200px;
      text-align: left;
      font-size: 16px;
      color: #999999;
      background-color: black;
      z-index: 3;
   }

   .modemSaveButton
   {
      position: absolute;
      bottom: 200px;
      font-size: 20px;
      background-color: lightgreen;
   }

   .linkTo
   {
      font-size: 18px;
      background-color: lightyellow;
   }

   .modeData
   {
      position: relative;
      width: 100%;
      height: 295px;
      top: 1px;
   }

   .messages
   {
      width: 50%;
   }

   .messageTable
   {
      position: relative;
      width: 100%;
      color: white;
   }

   .messageTable tr
   {
      height: 20px;
   }

   .messageSpan
   {
      position: relative;
      display: inline-block;
      width: 100%;
      color: yellow;
      font-weight: bold;
      height: 290px;
      max-height: 290px;
      overflow-y: auto;
      scrollbar-color: red yellow;
   }

   .refl_dropdown
   {
      position: relative;
   }

   .mode_options
   {
      position: relative;
   }

   .mode_options input
   {
      width: 150px;
   }

   .mode_options button
   {
      font-size: 18px;
      background-color: lightyellow;
   }

   .mode_section
   {
      position: relative;
      background-color: #a9ec9799;
      border-style: solid;
      border-color: yellow;
      border-width: 3px;
   }
   </style>
</head>

<body id='dashb' onload="setTimeout(initDashBd, 2000)">

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script type='text/javascript' charset='utf-8'>
var mode = "";
var type = "";
var duplex = false;
var station_latitude = 0.0;
var station_longitude = 0.0;
var username = "admin";
var rptrCallsign = "N0CALL";
var dashboardTitle = "Modem Dashboard";
var modem = "MMDVM";
var commport = "";
var newCall = "no";
var tx_state = "off";
var srcCall = "";
var dstCall = "";
var metaText = "";
var smsText = "";
var activeModes = "none";
var currentMode = "idle";
var modeOptions = [];
var mdActive = [];
var activeGateways = "none";
var authenticated = false;
var rid = "";
var last_rid = "x";
var modemFields = "";
var map;
var marker;

/* Initialize page structure */
function openPage(tabln,tab,pageName,elmnt,color)
{
  if (pageName == "settingstab" && !authenticated)
    return;
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName(tab);
  for (i = 0; i < tabcontent.length; i++)
  {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName(tabln);
  for (i = 0; i < tablinks.length; i++)
  {
    tablinks[i].style.backgroundColor = "";
  }
  document.getElementById(pageName).style.display = "block";
  elmnt.style.backgroundColor = color;
}

/* Load configuration and start refresh processes */
function initDashBd()
{
  getConfig();
  setTimeout(fetchStatus, 2000);
  setTimeout(buildHistoryTable, 3000);
  setTimeout(updateClock, 1000);
}

/* Save mode options to database */
async function saveModeOption(mode, id)
{
  var value = document.getElementById(mode+"_"+id).value;
  if (value == "")
  {
    alert("Value cannot be blank.");
    return;
  }
  var url = "data_query.php?command=saveModeOption&mode="+mode+"&parameter="+id+"&value="+encodeURIComponent(value);
  var resp = await fetch(url);
  if (resp.ok)
  {
    var tmp = await resp.text();
    if (tmp == "failed")
      alert("Save failed.");
    else
    {
      document.body.style.cursor = 'wait';
      url = "data_query.php?command=dashbCom&action=updateConf"+mode+"&parameter=readConfig";
      resp = await fetch(url);
      if (resp.ok)
      {
        var tmp = await resp.text();
        if (tmp != "success")
        {
          alert("Set new config failed!");
        }
        else
          alert("Update successful.");
      }
      document.body.style.cursor = 'default';
    }
  }
  else
    alert("Save failed.");
}

/* Display mode options in Mode tab */
function displayModeOptions(mode, dtype, id, value)
{
  if (document.getElementById('span_'+mode+'_'+id) || mode == "none")
    return;

  if (!document.getElementById(mode+'_section'))
  {
    var section = "<div class='mode_section' id='"+mode+"_section'>";
    section += "<label style='font-weight: bold;'>"+mode+" Section</label><br>";
    section += "</div>";
    var tmp = document.getElementById("modetab").innerHTML;
    document.getElementById("modetab").innerHTML = tmp+section;
  }

  if (value != "none")
  {
    var content = document.getElementById(mode+"_section").innerHTML;
    var html = "<span class='mode_options' id='span_"+mode+"_"+id+"'>";
    html += "<label>"+id+"</label>";
    if (dtype == "input")
    {
      html += "&nbsp;<input id='"+mode+"_"+id+"' type='text' value='"+value+"'>";
      html += "&nbsp;<button onclick='saveModeOption(\""+mode+"\", \""+id+"\")'>Save</button>";
    }
    html += "<br></span>";
    document.getElementById(mode+"_section").innerHTML = content+html;
  }
}

/* Step through mode options array and call display function */
function addMode()
{
  if (modeOptions.length > 0)
  {
    for (var i=0;i<modeOptions.length;i++)
    {
      if (modeOptions[i] != "none")
      {
        for (var j=0;j<modeOptions[i].length;j++)
        {
          var secs = modeOptions[i][j].split('\x1C');
          var fields = secs[0].split('\x1D');
          var param = fields[1];
          fields = secs[1].split('\x1D');
          var dtype = fields[1];
          fields = secs[2].split('\x1D');
          var value = fields[1];
          displayModeOptions(mdActive[i], dtype, param, value);
        }
      }
      else
        displayModeOptions(mdActive[i], "", "", "none");
    }
  }
}

/* Update mode status. IE. Idle, RX or TX */
function updateModeStatus()
{
  var table = "<table class='activeModes'><tr><th>Modes</th><th>Status</th></tr>";
  if (activeModes != "")
  {
    var tmp = activeModes.split(',');
    for (var i=0;i<tmp.length;i++)
    {
      stat = "Idle";
      if (document.getElementById(tmp[i]+'_stat'))
        stat = document.getElementById(tmp[i]+'_stat').innerHTML;
      if (stat == "RX" && currentMode != tmp[i])
        stat = "Idle";
      table += "<tr><td>"+tmp[i]+"</td><td id='"+tmp[i]+"_stat'>"+stat+"</td></tr>";
    }
  }
  table += "</table>";
  document.getElementById('activeModes').innerHTML = table;
}

/* Load mode options from database and call display functions */
async function configModes(prevModes)
{
  let myPromise = new Promise(async function(resolve, reject)
  {
    if (mdActive.length > 0)
    {
      modeOptions.length = 0;
      var url = "";
      for (var i=0;i<mdActive.length;i++)
      {
        if (mdActive[i] == "none")
          continue;
        url = "data_query.php?command=getModeOptions&mode="+mdActive[i];
        var resp = await fetch(url);
        if (resp.ok)
        {
          var tmp = await resp.text();
          if (tmp != "none")
          {
            modeOptions[i] = tmp.split('\x1E');
          }
          else
            modeOptions[i] = "none";
        }
      }
    }
    addMode();
    resolve("ok");
  });
  await myPromise;
}

/* Load current reflector link status from database and update display */
async function updateGatewayStatus()
{
  if (activeGateways != "")
  {
    var url = "data_query.php?command=getLinkedReflectors";
    var resp = await fetch(url);
    if (resp.ok)
    {
      var tmp = await resp.text();
      if (tmp != "none")
      {
        var lines = tmp.split('\x1E');
        for (var i=0;i<lines.length;i++)
        {
          fields = lines[i].split('\x1C');
          values = fields[0].split('\x1D');
          type = values[1];
          values = fields[1].split('\x1D');
          name = values[1];
          values = fields[2].split('\x1D');
          module = values[1];
          if (document.getElementById(type+'link'))
          {
            document.getElementById(type+'net').value = name;
            document.getElementById(type+'netmod').value = module;
            if (document.getElementById(type+'_linkstat'))
              document.getElementById(type+'_linkstat').innerHTML = "Linked to "+name+" "+module;
            document.getElementById(type+'link').textContent = "Unlink";
          }
        }
      }
    }

    tmp = activeGateways.split(',');
    for (var i=0;i<tmp.length;i++)
    {
      stat = "Not Linked";
      if (document.getElementById(tmp[i]+'_linkstat'))
        stat = document.getElementById(tmp[i]+'_linkstat').innerHTML;
    }
  }
}

/* Display and update clocks */
function updateClock()
{
    const date = new Date();
    var tmp = date.toUTCString().split(' ');
    var dt = tmp[2] + " " + tmp[1] + " " + tmp[4] + " UTC";
    document.getElementById('clock').innerHTML = dt;
    tmp = date.toString().split(' ');
    dt = tmp[0] + " " + tmp[1] + " " + tmp[2] + " " + tmp[3] + " " + tmp[4];
    document.getElementById('lclock').innerHTML = dt;

    setTimeout(updateClock, 1000);
}

/* Load general configuraion from database */
async function getConfig()
{
  activeGateways = "";
  activeModes = "";
  var url = "data_query.php?command=getModemConfig";
  var resp = await fetch(url);
  if (!resp.ok) return;
  var tmp = await resp.text();
  if (tmp == "none") return;
  tmp = tmp.split('\x1E');
  for (var i=0;i<tmp.length;i++)
  {
    var fields = tmp[i].split('\x1D');
    if (fields[0] == 'mode')
    {
      if (fields[1] == 'duplex')
      {
        duplex = true;
        document.getElementById('mode').value = "duplex";
      }
      else
      {
        duplex = false;
        document.getElementById('mode').value = "simplex";
      }
    }
    if (fields[0] == 'modem')
    {
      modem = fields[1];
      document.getElementById('deviceType').value = modem;
    }
    if (fields[0] == 'port')
    {
      commport = fields[1];
      document.getElementById('commPort').value = commport;
    }
    if (fields[0] == 'baud')
    {
      baud = fields[1];
      document.getElementById('baud').value = baud;
    }
  }

  var modemExtras = "";
  modemFields = "";
  for (var i=0;i<tmp.length;i++)
  {
    var fields = tmp[i].split('\x1D');
    if (fields[0] == 'mode' || fields[0] == 'modem' || fields[0] == 'baud' || fields[0] == 'port')
      continue;
    modemExtras += "<label style='display:inline-block;width:200px'>"+fields[0]+"</label>&nbsp;<input id='"+fields[0]+"' type='text' value='"+fields[1]+"'><br>";
    if (modemFields != "") modemFields += ",";
    modemFields += fields[0];
  }
  document.getElementById('modemExtras').innerHTML = modemExtras;

  url = "data_query.php?command=getDashConfig";
  resp = await fetch(url);
  if (!resp.ok) return;
  tmp = await resp.text();
  if (tmp == "none") return;
  tmp = tmp.split('\x1E');
  for (var i=0;i<tmp.length;i++)
  {
    var fields = tmp[i].split('\x1D');
    if (fields[0] == 'title')
    {
      dashboardTitle = fields[1];
      document.getElementById('title').value = dashboardTitle;
      document.getElementById('windowTitle').innerHTML = dashboardTitle;
      document.getElementById('dashTitle').innerHTML = dashboardTitle;
    }
    if (fields[0] == 'username')
    {
      username = fields[1];
      document.getElementById('username').value = username;
      document.getElementById('fusername').value = username;
    }
    if (fields[0] == 'callsign')
    {
      rptrCallsign = fields[1];
      document.getElementById('callsign').value = rptrCallsign;
    }

    if (fields[0] == 'latitude')
    {
      station_latitude = fields[1];
      document.getElementById('station_latitude').value = Number(station_latitude);
    }

    if (fields[0] == 'longitude')
    {
      station_longitude = fields[1];
      document.getElementById('station_longitude').value = Number(station_longitude);
    }
  }
  map.setView([Number(station_latitude), Number(station_longitude)], 10);
  marker.remove();
  marker = new L.Marker([Number(station_latitude), Number(station_longitude)]);
  marker.addTo(map);
}

/* Setup and initialize gateway display */
function configGateways(prevGateways)
{
  if (prevGateways != "none")
  {
    var modes = prevGateways.split(',');
    for (var i=0;i<modes.length;i++)
    {
       var ele = document.getElementById(modes[i]+'_refl');
       if (ele)
         ele.remove();
       ele = document.getElementById(modes[i]+'_gateway');
       if (ele)
         ele.remove();
    }
  }
  if (activeGateways == "none")
    return;
  var modes = activeGateways.split(',');

  var table = "";
  for (var i=0;i<modes.length;i++)
  {
    html = document.getElementById(modes[i]+"_section").innerHTML;
    html += createReflDropDown(modes[i]);
    document.getElementById(modes[i]+"_section").innerHTML = html;
    getReflList(modes[i]);

    if (i > 0) table += "<br>";
    table += "<table id='"+modes[i]+"_gateway' class='activeGW'><tr><th>"+modes[i]+" Gateway</th></tr>";
    table += "<tr><td id='"+modes[i]+"_linkstat'>Not Linked</td></tr>";
    table += "</table>";
  }
  document.getElementById('activeGW').innerHTML = table;

  updateGatewayStatus();
}

/* Load current host status from database */
async function fetchStatus()
{
  var txEnabled = false;
  var fields;
  var latitude = "";
  var longitude = "";
  var altitude = "";
  var bearing = "";
  var speed = "";
  var smsText = "";
  var url = "data_query.php?command=getStatus";
  var resp = await fetch(url);
  if (!resp.ok)
  {
    setTimeout(fetchStatus, 1000);
    return;
  }
  var tmp = await resp.text();
  if (tmp == "none")
  {
    setTimeout(fetchStatus, 1000);
    return;
  }
  tmp = tmp.split('\x1C');
  for (var i=0;i<tmp.length;i++)
  {
    fields = tmp[i].split('\x1D');
    if (fields[0] == 'Id')
      rid = fields[1];
    if (fields[0] == 'tx_state')
    {
      tx_state = fields[1];
      if (tx_state == "on")
        txEnabled = true;
      else
        txEnabled = false;
    }
    if (fields[0] == 'srcCall')
    {
      srcCall = fields[1];
      if (srcCall == "")
        break;
    }
    if (fields[0] == 'mode')
      mode = fields[1];
    if (fields[0] == 'type')
      type = fields[1];
    if (fields[0] == 'dstCall')
      dstCall = fields[1];
    if (fields[0] == 'metaText')
      metaText = decodeURIComponent(fields[1]);
    if (metaText.trim() == "")
      metaText = "none";
    if (fields[0] == 'latitude')
      latitude = fields[1];
    if (fields[0] == 'longitude')
      longitude = fields[1];
    if (fields[0] == 'altitude')
      altitude = fields[1];
    if (fields[0] == 'bearing')
      bearing = fields[1];
    if (fields[0] == 'speed')
      speed = fields[1];
    if (fields[0] == 'smsText')
      smsText = fields[1];
    if (fields[0] == 'property')
    {
      if (fields[1] == 'active_mode')
      {
        i++;
        value = tmp[i].split('\x1D');
        currentMode = value[1];
      }
    }
  }
  if (rid != last_rid)
  {
    if (smsText != "")
      addMessage(srcCall, decodeURIComponent(smsText));
    if (latitude != "" && longitude != "")
    {
      map.setView([Number(latitude), Number(longitude)], 10);
      marker.remove();
      marker = new L.Marker([Number(latitude), Number(longitude)]);
      marker.addTo(map);
    }
    last_rid = rid;
  }
  document.getElementById('cmode').innerHTML = mode;
  document.getElementById('srcCall').innerHTML = srcCall;
  if (srcCall != '')
  {
    newCall = "yes";
  }
  document.getElementById('dstCall').innerHTML = dstCall;
  document.getElementById('metaText').innerHTML = metaText.trim();

  if (txEnabled && mode == currentMode)
  {
    var rtx = document.getElementById('rtx');
    rtx.style.background = 'red';
    rtx.style.color = 'white';
    if (document.getElementById(mode+'_stat'))
      document.getElementById(mode+'_stat').innerHTML = "TX";
    //currentMode = mode;
  }
  else
  {
    var rtx = document.getElementById('rtx');
    rtx.style.background = '#D6EEEE';
    rtx.style.color = '#528dea';
    if (document.getElementById(mode+'_stat') && mode == currentMode)
      document.getElementById(mode+'_stat').innerHTML = "RX";
  }

  var prevModes = activeModes;
  var prevGateways = activeGateways;

  url = "data_query.php?command=getDashConfig";
  resp = await fetch(url);
  if (!resp.ok)
  {
    setTimeout(fetchStatus, 1000);
    return;
  }
  tmp = await resp.text();
  if (tmp == "none")
  {
    setTimeout(fetchStatus, 1000);
    return;
  }
  var modeChanged = false;
  tmp = tmp.split('\x1E');
  for (var i=0;i<tmp.length;i++)
  {
    var fields = tmp[i].split('\x1D');
    if (fields[0] == 'activeModes')
    {
      if (fields[1] != activeModes)
      {
        modeChanged = true;
        document.getElementById('modetab').innerHTML = "";
        activeModes = fields[1];
        mdActive.length = 0;
        if (activeModes != "")
        {
          md = activeModes.split(',');
          for (var x=0;x<md.length;x++)
          {
            mdActive[x] = md[x];
          }
        }
        configModes(prevModes);
      }
    }

    if (fields[0] == 'gateways' &&  activeModes != "none")
    {
      if (fields[1] != activeGateways)
      {
        activeGateways = fields[1];
      }
    }
  }

  if ((prevGateways != activeGateways) || modeChanged)
    setTimeout(configGateways, 700, prevGateways);
  else
    updateGatewayStatus();

  updateModeStatus();

  setTimeout(fetchStatus, 1000);
}

/* Load communcations history from database and update display table */
async function buildHistoryTable()
{
  var fields;
  var hType = "";
  var hMode = "";
  var hSource = "";
  var hDest = "";
  var hLoss_BER = "";
  var hMessage = "";
  var hDateTime = "";
  var hDuration = "";

  var url = "data_query.php?command=getHistory";
  var resp = await fetch(url);
  if (!resp.ok)
  {
    setTimeout(buildHistoryTable, 5000);
    return;
  }
  var line = await resp.text();
  if (line == "none")
  {
    setTimeout(buildHistoryTable, 5000);
    return;
  }
  lines = line.split('\x1E');

  var table = "<table id='lastheard' class='lastheard'>";
  table += "<thead><tr style='background:green;color:yellow;'><th>Date/Time</th><th>Call</th><th>Message</th><th>Destination</th><th>Mode</th><th>Loss/BER</th><th>Len(secs)</th></tr></thead><tbody>";
  for (var i=0;i<lines.length;i++)
  {
    tmp = lines[i].split('\x1C');
    for (var j=0;j<tmp.length;j++)
    {
      fields = tmp[j].split('\x1D');
      if (fields[0] == 'type')
        hType = fields[1];
      if (fields[0] == 'mode')
        hMode = fields[1];
      if (fields[0] == 'source')
        hSource = fields[1];
      if (fields[0] == 'dest')
        hDest = fields[1];
      if (fields[0] == 'loss_ber')
        hLoss_BER = fields[1];
      if (fields[0] == 'ss_message')
        hMessage = fields[1];
      if (fields[0] == 'datetime')
        hDateTime = fields[1];
      if (fields[0] == 'duration')
        hDuration = fields[1];
    }
    table += "<tr><td>"+hDateTime+"</td>";
    table += "<td>"+hSource+"</td>";
    table += "<td>"+hMessage+"</td>";
    table += "<td>"+hDest+"</td>";
    table += "<td>"+hMode+"-"+hType+"</td>";
    table += "<td>"+hLoss_BER+"</td>";
    table += "<td>"+hDuration+"</td></tr>";
  }
  table += "</tbody></table>"
  document.getElementById('lastheardDiv').innerHTML = table;

  setTimeout(buildHistoryTable, 5000);
}

/* Check if user authenticated for admin functions */
function checkAuth()
{
  if (!authenticated)
  {
     document.getElementById('id01').style.display='block';
     setTimeout("document.getElementById('fpassword').focus()", 500);
  }
  else
    openPage('tablink', 'tabcontent', 'settingstab', document.getElementById('Settings'), 'green');
}

/* Login process for administrative functions */
async function doAuthentication()
{
  username = document.getElementById('fusername').value;
  var password = document.getElementById('fpassword').value;
  var url = "data_query.php?command=auth&username="+username+"&passwd="+encodeURIComponent(password);
  var resp = await fetch(url);
  if (!resp.ok) return;
  var tmp = await resp.text();
  if (tmp == "authfailed")
    authenticated = false;
  if (tmp == "authpassed")
  {
    authenticated = true;
    document.getElementById('id01').style.display='none';
    openPage('tablink', 'tabcontent', 'settingstab',  document.getElementById('Settings'), 'green');
  }
}

/* Save modem configuraion */
async function saveModem()
{
  document.body.style.cursor = 'wait';
  var modemName = "modem1"; // this may change if multiple modems are used.
  var newDevice = document.getElementById('deviceType').value;
  var newcommPort = document.getElementById('commPort').value;
  var newBaud = document.getElementById('baud').value;
  var newMode = document.getElementById('mode').value;
  var elist = document.getElementById('modemExtras').querySelectorAll("input");
  var params = "";
  for (var x=0;x<elist.length;x++)
  {
    params += "&"+elist[x].id+"="+elist[x].value;
  }
  var url = "data_query.php?command=saveModem&modem_name="+modemName+params+"&modem="+newDevice+"&port="+newcommPort+"&baud="+newBaud+"&mode="+newMode;
  var resp = await fetch(url);
  if (!resp.ok)
  {
    document.body.style.cursor = 'default';
    alert("Set new config failed!");
    return;
  }
  var tmp = await resp.text();
  if (tmp != "success")
  {
    document.body.style.cursor = 'default';
    alert(tmp);
  }
  else
  {
    url = "data_query.php?command=dashbCom&action=modemHost&parameter=setConfig";

    var resp = await fetch(url);
    if (!resp.ok)
    {
      document.body.style.cursor = 'default';
      alert("New config failed to download to modem!");
      return;
    }
    var tmp = await resp.text();
    document.body.style.cursor = 'default';
    if (tmp != "success")
    {
      alert("New config failed to download to modem!");
    }
    else
      alert("Saved successfully.");
  }
}

/* Save general configuraion */
async function saveGeneral()
{
  var newTitle = document.getElementById('title').value;
  var newCall = document.getElementById('callsign').value;
  var newLatitude = document.getElementById('station_latitude').value;
  var newLongitude = document.getElementById('station_longitude').value;
  var moduleName = "main"; // this may change if multiple modems are used.

  var url = "data_query.php?command=saveGeneral&moduleName="+moduleName+"&title="+newTitle+"&callsign="+newCall;
  url += "&latitude="+newLatitude+"&longitude="+newLongitude;
  var resp = await fetch(url);
  if (!resp.ok) return;
  var tmp = await resp.text();
  if (tmp != "success")
    alert(tmp);
  else
  {
    getConfig();
    alert("Saved successfully.");
  }
}

async function saveAuth()
{
  var newUsername = document.getElementById('username').value;
  var newPassword = document.getElementById('password').value;
  var newRPassword = document.getElementById('rpassword').value;
  var moduleName = "main"; // this may change if multiple modems are used.

  if (newPassword != newRPassword)
  {
    alert("Passwords do not match!");
    return;
  }
  if (newPassword == "")
  {
    alert("Password cannot be blank.");
    return;
  }
  var url = "data_query.php?command=saveGeneral&moduleName="+moduleName+"&username="+newUsername+"&passwd="+newPassword;
  var resp = await fetch(url);
  if (!resp.ok) return;
  var tmp = await resp.text();
  if (tmp != "success")
    alert(tmp);
  else
  {
    getConfig();
    alert("Saved successfully.");
  }
}

/* Load reflector list for give mode type and add to drop down */
async function getReflList(reflType)
{
  var list = document.getElementById(reflType+'net');
  list.options.length = 0;
  var url = "data_query.php?command=getReflectors&refl_type="+reflType;
  var resp = await fetch(url);
  if (!resp.ok) return;
  var tmp = await resp.text();
  if (tmp == "none" || tmp == "failed") return;
  tmp = tmp.split('\x1E')
  for (var i=0;i<tmp.length;i++)
  {
      var fields = tmp[i].split('\x1C');
      var value = fields[0].split('\x1D');
      var newOpt = document.createElement('option');
      newOpt.value = value[1];
      newOpt.text = value[1];
      list.add(newOpt);
  }
}

/* Use database to send command to link/unlink reflector */
async function reflConnect(reflType)
{
  var url;
  var action;
  var srcCall = document.getElementById('callsign').value;
  var name = document.getElementById(reflType+'net').value;
  var mod = document.getElementById(reflType+'netmod').value;
  var link = document.getElementById(reflType+'link').textContent;
  action = "unlink";
  if (link == "Link")
    action = "link,"+name+","+mod;
  url = "data_query.php?command=dashbCom&action=reflLink"+reflType+"&parameter="+action;

  document.body.style.cursor = 'wait';
  var resp = await fetch(url);
  if (!resp.ok)
  {
    document.body.style.cursor = 'default';
    return;
  }
  var tmp = await resp.text();
  if (tmp != "success")
  {
    alert(action + " failed!");
  }
  else
  {
    if (document.getElementById(reflType+'link').textContent == "Link")
    {
        document.getElementById(reflType+'link').textContent = "Unlink";
        document.getElementById(reflType+'_linkstat').innerHTML = "Linked to "+name+" "+mod;
    }
    else
    {
        document.getElementById(reflType+'link').textContent = "Link";
        document.getElementById(reflType+'_linkstat').innerHTML = "Not Linked";
    }
  }
  document.body.style.cursor = 'default';
}

/* Create and setup empty reflector drop down lists */
function createReflDropDown(reflType)
{
  html = "<span class='refl_dropdown' id='"+reflType+"_refl'><br>";
  html += "<label for='"+reflType+"net'>Reflector:</label>";
  html += "<select id='"+reflType+"net' name='"+reflType+"net'></select>";
  html += "&nbsp;<select id='"+reflType+"netmod'>";
  for (x=65;x<65+26;x++)
    html += "<option value='"+String.fromCharCode(x)+"'>"+String.fromCharCode(x)+"</option>";
  html += "</select>";
  html += "&nbsp;<button id='"+reflType+"link' class='linkto' onclick='reflConnect(\""+reflType+"\")'>Link</button>";
  html += "</span>";
  return html;
}

/* Create and display map centered on current GSP coordinates */
function createMap(lat, long)
{
  var mapOptions = {
                     center: [lat, long],
                     zoom: 10
                   }

  if (map)
  {
    map.off();
    map.remove();
  }

  // Creating a map object
  map = new L.map('mapLoc', mapOptions);

  // Creating a Layer object
  var layer = new L.TileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

  // Adding layer to the map
  map.addLayer(layer);

  marker = new L.Marker([lat, long]);
  marker.addTo(map);
}

/* Add incoming message to message display list */
function addMessage(source, message)
{
  var table = document.getElementById('messageTable');
  var newRow = table.insertRow(0);
  var newCell = newRow.insertCell(0);
  newCell.textContent = message;
  newRow = table.insertRow(0);
  newCell = newRow.insertCell(0);
  newCell.style.color = "white";
  newCell.style.backgroundColor = "#00610D";
  newCell.textContent = source;
}
</script>

<!-- ################################## End Script ###################################################### -->

<!-- login dialog -->
<div id="id01" class="modal">
  <form class="modal-content animate" action="" method="post">
    <div class="imgcontainer">
      <span onclick="document.getElementById('id01').style.display='none'" class="close" title="Close Modal">&times;</span>
    </div>
    <div class="container">
      <label for="uname"><b>Username</b></label>
      <input id="fusername" type="text" placeholder="Enter Username" name="uname" required>

      <label for="psw"><b>Password</b></label>
      <input id="fpassword" type="password" placeholder="Enter Password" name="psw" required>

      <button id="loginButton" class="login" type="button" onclick="doAuthentication()">Login</button>
<!--  <label>
      <input type="checkbox" checked="checked" name="remember"> Remember me
      </label> -->
    </div>

    <div class="container" style="background-color:#f1f1f1">
      <button type="button" onclick="document.getElementById('id01').style.display='none'" class="cancelbtn">Cancel</button>
    </div>
  </form>
</div>
<!-- end login dialog -->

<div class='banner'>
  <span id='banner'>
    <span id=dashTitle>Modem Dashboard</span><br>
    <span id=dashTitle2 style='font-size:14;'>Version 1.0 beta</span>
  </span>

  <span class='lclock' id='lclock'></span>
  <span class='clock' id='clock'></span>
</div>

<div class='main'>
  <div class='tabs'>
    <button id='Dashboard' class="tablink" onclick="openPage('tablink', 'tabcontent', 'maintab', this, 'blue')">Dashboard</button>
    <button id='Settings' class="tablink" onclick="checkAuth()">Settings</button>
  </div>

  <div id='maintab' class='tabcontent'>
    <div class='currentComm'>
      <table class='currentCall' id='currentCall'>
        <tr><th>Call</th><th>Message</th><th>Mode</th><th>Destination</th></tr>
        <tr id='rtx'><td id='srcCall'></td><td id='metaText'></td><td id='cmode'></td><td id='dstCall'></td></tr>
      </table>
      <table id='modeData' class='modeData'>
        <tr>
          <td id='messages' class='messages'><span class='messageSpan'>Messages:<br><table id='messageTable' class='messageTable'></table></span></td>
          <td id='mapLoc'></td>
        </tr>
      </table>
    </div>

    <div id='lastheardDiv' class='lastheardDiv'>
        <table id='lastheard' class='lastheard'>
          <tr style='background:green;color:yellow;'><th>Date/Time</th><th>Call</th><th>Message</th><th>Destination</th><th>Mode</th><th>Loss/BER</th><th>Len(secs)</th></tr>
          <tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>
        </table>
    </div>
  </div>

  <div id='settingstab' class='tabcontent'>
    <div class='stabs'>
      <button id='General' class="stablink" onclick="openPage('stablink', 'genset', 'generaltab', this, 'orange')">General</button>
      <button class='stablink' onclick="openPage('stablink', 'genset', 'modemtab', this, 'yellow')">Modem</button>
      <button class='stablink' onclick="openPage('stablink', 'genset', 'modetab', this, 'lightblue')">Modes</button>
    </div>
    <div id='generaltab' class='genset'>
      <span class='genSettings'>
        <label for='title'>Title:</label>
        <input id='title' type='text' value='Modem Dashboard' size='40' maxlength='40' autofocus>
        <label for='callsign'>Callsign:</label>
        <input id='callsign' type='text' size='8' maxlength='8'>
        <span class='settingsLocation'>
          <label for='station_latitude'>Latitude:</label>
          <input id='station_latitude' type='float' value='0.0'><br><br>
          <label for='station_longitude'>Longitude:</label>
          <input id='station_longitude' type='float' value='0.0'>
        </span>
        <button class='genSaveButton' onclick='saveGeneral()'>Save</button>
        <span class='settingsauth'>
          <label for='username'>User:</label>
          <input id='username' type='text' value='admin' size='20' minlength='4' maxlength='20'>
          <br><br>
          <label for='password'>Password:</label>
          <input id='password' type='password' size='20' minlength='8' maxlength='40'>
          <br><br>
          <label for='rpassword'>Retype Password:</label>
          <input id='rpassword' type='password' size='20' minlength='8' maxlength='40'>
          <button class='authSaveButton' onclick='saveAuth()'>Save</button>
        </span>
      </span>
    </div>
    <div id='modemtab' class='genset'>
     <span class='modemSettings'>
        <label for='deviceType'>Device Type:</label>
        <select id='deviceType' name='devtype'>
          <option value="Module17">Module17</option>
          <option value="mmdvm">MMDVM</option>
          <option value="mmdvmhs">MMDVM_HS</option>
        </select>
        <label for='commPort'>Comm Port:</label>
        <select id='commPort' name='commPort'>
          <option value="ttyACM0">ttyACM0</option>
          <option value="ttyACM1">ttyACM1</option>
          <option value="ttyACM2">ttyACM2</option>
          <option value="ttyAMA0">ttyAMA0</option>
          <option value="ttyAMA1">ttyAMA1</option>
          <option value="ttyAMA2">ttyAMA2</option>
          <option value="ttyUSB0">ttyUSB0</option>
          <option value="ttyUSB1">ttyUSB1</option>
          <option value="ttyUSB2">ttyUSB2</option>
          <option value="ttyS0">ttyS0</option>
          <option value="ttyS1">ttyS1</option>
          <option value="ttyS2">ttyS2</option>
        </select>
        <label for='baud'>Baud:</label>
        <select id='baud' name='baud'>
          <option value="115200">115200</option>
          <option value="230400">230400</option>
          <option value="460800">460800</option>
        </select>
        <label for='mode'>Mode:</label>
        <select id='mode' name='mode'>
          <option value="simplex">Simplex</option>
          <option value="duplex">Duplex</option>
        </select><br><br>
        <span id='modemExtras' class='mExtrasSettings'>
        </span>
        <br><br><button class='modemSaveButton' onclick='saveModem()'>Save</button>
      </span>
    </div>
    <div id='modetab' class='genset'>
    </div>
  </div>
</div>

<div class='status'>
  <span class='subStatus' id='status'>
    <span id='activeModes'></span>
    <br>
    <span id='activeGW'></span>
  </span>
</div>

<div class='creator'>
  <span  id='creator'>Created by: Rick KD0OSS (c)2025</span>
</div>

<script type='text/javascript' charset='utf-8'>
/* Select default tabs on startup */
document.getElementById("Dashboard").click();
document.getElementById("General").click();
createMap(Number(station_latitude), Number(station_longitude));
</script>

</body>
</html>

